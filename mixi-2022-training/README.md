# データベース研修【ミクシィ22新卒技術研修】<!-- omit in toc -->
## 目次<!-- omit in toc -->
- [資料](#資料)
- [データシステム基礎](#データシステム基礎)
  - [なぜデータベースを学ぶのか](#なぜデータベースを学ぶのか)
  - [DBシステム](#dbシステム)
    - [機能要件と非機能要件の2つを意識する](#機能要件と非機能要件の2つを意識する)
    - [信頼性](#信頼性)
  - [データモデル](#データモデル)
    - [リレーショナルデータモデル](#リレーショナルデータモデル)
    - [クエリ言語](#クエリ言語)
    - [ドキュメントモデル](#ドキュメントモデル)
    - [Schema](#schema)
  - [データベース管理システム（DBMS）](#データベース管理システムdbms)
  - [エンコーディングと進化](#エンコーディングと進化)
- [分散データの取り扱い](#分散データの取り扱い)
  - [レプリケーション](#レプリケーション)
  - [パーティショニング](#パーティショニング)
  - [トランザクション](#トランザクション)

## 資料
- [動画](https://youtu.be/dseGQ2MZF1U)
- [座学スライド](https://speakerdeck.com/mixi_engineers/2022-database-training)
- [ハンズオンスライド](https://speakerdeck.com/mixi_engineers/2022-sql-training)

## データシステム基礎
### なぜデータベースを学ぶのか
- 演算指向からデータ指向へのシフト
  - CPUの処理能力ではなく、データ量やデータの複雑さ・データ変化がボトルネックになる時代になった
- DBはアプリケーションに比べて**後から変更しにくい**

### DBシステム
#### 機能要件と非機能要件の2つを意識する
- 機能要件
  - データの保存・検索
  - 頻繁にアクセスされるデータのキャッシュ
  - キーワード検索
- 非機能要件
  - 障害時にもデータの整合性を保証
  - 負荷増大に対応
  - 安定したパフォーマンス

#### 信頼性
- 問題を起こしうるもの＝フォールト（fault）
  - フォールトに対応可能なシステムを**fault tolerant**という

### データモデル
- データベース世界の汎用的なデータモデル
  - リレーショナルデータモデル
  - オブジェクト指向モデル
  - ネットワークデータ（グラフ）モデル
- ソフトウェアのできること・できないことに大きな影響を及ぼす
> **Note** <!-- Note / Warning -->
> アプリケーションに適したデータモデルを選択することが重要

#### リレーショナルデータモデル
- 数学的で徹底的にフォーマルなデータモデル
  - 集合論に基づいたデータ表現
  - 実装には無関心 => データ独立性
    - 実装とデータモデルが直接的に関係していない
- データモデルは**原理**
  - 原理＝根源、本質的な性質、基礎
  - 製品や技術は変化するが原理は持続力がある
- リレーショナルモデルの3要素
  - 構造：リレーション、順序なしタプルの集合
  - 操作：集合操作と論理述語
  - 整合性：常に満たさなければならない式

#### クエリ言語
- SQL
  - リレーショナルモデルを設計基盤として開発された宣言型クエリ言語
  - 集合を基本のデータ構造とする
    - OOM（オブジェクト指向モデル）とはデータ構造の違いが存在（= インピーダンスミスマッチ）

#### ドキュメントモデル
- スキーマを強制しない
- 関連情報が一箇所に集まっている
- 結合のサポートが弱い
- OSS： MongoDB, CouchDB, RethinkDB
- Cloud: Firebase Firestore

#### Schema
- スキーマオンライト
  - スキーマを明示
  - 書き込み時にスキーマに従っていることを保証
  - スキーマの変更にマイグレーションが必要

- スキーマオンリード
  - スキーマを強制しない
  - データ構造は暗黙
    - 読み取り時に解釈

### データベース管理システム（DBMS）
DBMSはクライアント/サーバモデル
- クエリプロセッサ
  - クエリを受け取り解析
  - クエリ実行計画
- 実行エンジン
  - 実行計画を処理
- ストレージエンジン
  - トランザクションなどを管理

### エンコーディングと進化
エンコーディングによって互換性を担保
- エンコーディング
  - インメモリの表現からバイトの並びへの変換
  - メモリ内のデータの持ち方とメモリ外でのデータの持ち方は異なる
- 後方互換性
  - 古いコードによって書かれたデータを新しいデータが読める
- 前方互換性
  - 新しいコードによって書かれたデータを古いコードが読める
    - ローリングアップデートのような新旧サーバが混在するような状況
  - 難しい


## 分散データの取り扱い
### レプリケーション
**複数のマシンに同じデータのコピーを保持しておくこと**
- レプリケーションの目的
  - レイテンシを下げる
  - 障害があってもシステムを動作可能
  - すケースアウトさせる
- 3つのアプローチ
  - シングルリーダー、マルチリーダー、リーダーレス
- レプリケーションにおけるトレードオフ
  - 同期的にやるか、非同期でやるか
  - 障害を起こしたときにどうするのか？
    - リードレプリカをプライマリに昇格させる等

### パーティショニング
データを分割して保存する
- **スケーラビリティの向上**が目的
  - クエリの負荷分散
- 偏りがある状態を skew と呼ぶ
  - 負荷集中しているパーティションをホットスポットと呼ぶ

### トランザクション
複数の読み書きを一つの論理的な単位としてまとめる方法
- 全体として成功か失敗
  - 一部だけ成功という状態は存在しない！
  - 成功（commit）、失敗（abort：中断、rollback：ロールバック）
- トランザクションが保証する一貫性の強さとパフォーマンスはトレードオフ
  - 理想は並列で実行しても直列で実行したときと同じ結果になること
